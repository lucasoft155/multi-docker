# Define el nombre del workflow de GitHub Actions
name: Deploy MultiDocker

# Define cuándo se ejecutará este workflow
on:
  # Se ejecuta cuando hay un push al repositorio
  push:
    # Especifica las ramas que activan el workflow
    branches:
      # Solo se ejecuta cuando hay push a la rama master
      - master

# Define los trabajos (jobs) que se ejecutarán
jobs:
  # Nombre del job: build
  build:
    # Especifica el sistema operativo donde se ejecutará (última versión de Ubuntu)
    runs-on: ubuntu-latest
    # Define los pasos que se ejecutarán en secuencia
    steps:
      # Paso 1: Descarga el código del repositorio
      - uses: actions/checkout@v3
      # Paso 2: Inicia sesión en Docker Hub usando credenciales secretas
      - run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
      # Paso 3: Construye la imagen Docker del cliente para pruebas usando Dockerfile.dev
      - run: docker build -t lucasoft155/react-test:v1.0 -f ./client/Dockerfile.dev ./client
      # Paso 4: Ejecuta los tests del cliente en un contenedor con la variable CI=true
      - run: docker run -e CI=true lucasoft155/react-test:v1.0 npm test

      # Paso 5: Construye la imagen Docker del cliente para producción
      - run: docker build -t lucasoft155/multi-client:v1.0 ./client
      # Paso 6: Construye la imagen Docker de nginx
      - run: docker build -t lucasoft155/multi-nginx:v1.0 ./nginx
      # Paso 7: Construye la imagen Docker del servidor
      - run: docker build -t lucasoft155/multi-server:v1.0 ./server
      # Paso 8: Construye la imagen Docker del worker
      - run: docker build -t lucasoft155/multi-worker:v1.0 ./worker

      # Paso 9: Sube la imagen del cliente a Docker Hub
      - run: docker push lucasoft155/multi-client:v1.0
      # Paso 10: Sube la imagen de nginx a Docker Hub
      - run: docker push lucasoft155/multi-nginx:v1.0
      # Paso 11: Sube la imagen del servidor a Docker Hub
      - run: docker push lucasoft155/multi-server:v1.0
      # Paso 12: Sube la imagen del worker a Docker Hub
      - run: docker push lucasoft155/multi-worker:v1.0

      # Paso 13: Nombre descriptivo del paso
      - name: Generate deployment package
        # Crea un archivo ZIP con todos los archivos excepto los de .git
        # El ZIP es necesario porque contiene el docker-compose.yml que le dice a AWS:
        # - Qué imágenes Docker descargar desde Docker Hub (nombres y versiones)
        # - Cómo ejecutar los contenedores (puertos, memoria, hostnames, variables de entorno)
        # - Relaciones entre servicios (links, networks)
        # Sin este ZIP, AWS no sabría qué imágenes usar ni cómo configurar los contenedores
        run: zip -r deploy.zip . -x '*.git*'

      # Paso 14: Nombre descriptivo del paso de despliegue
      - name: Deploy to EB
        # Usa una acción de terceros para desplegar a AWS Elast ic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v18
        # Configuración de parámetros para el despliegue
        with:
          # Clave de acceso de AWS desde los secretos
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
          # Clave secreta de AWS desde los secretos
          aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}
          # Nombre de la aplicación en Elastic Beanstalk
          application_name: multi-docker
          # Nombre del entorno en Elastic Beanstalk
          environment_name: Multi-docker-env
          # Nombre del bucket S3 existente para almacenar el paquete de despliegue
          existing_bucket_name: elasticbeanstalk-us-east-2-851334203913
          # Región de AWS donde se desplegará
          region: us-east-2
          # Etiqueta de versión usando el SHA del commit de GitHub
          version_label: ${{ github.sha }}
          # Archivo ZIP que contiene el paquete de despliegue
          deployment_package: deploy.zip
